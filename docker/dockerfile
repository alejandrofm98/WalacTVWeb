# Etapa 1: Build de Angular
FROM node:20-alpine AS builder

WORKDIR /app

# Copiar archivos de dependencias
COPY package*.json ./

# Instalar dependencias
RUN npm ci --legacy-peer-deps

# Copiar todo el c√≥digo fuente
COPY . .

# ARGs que vienen de Dokploy
ARG APP_NAME
ARG IPTV_API_URL

# üîß Crear environment.ts din√°micamente para que Angular compile correctamente
RUN echo "export const environment = { \
  production: true, \
  appName: '${APP_NAME}', \
  iptvApiUrl: '${IPTV_API_URL}' \
};" > src/environments/environment.ts

# Compilar Angular en modo producci√≥n
RUN npm run build -- --configuration production

# Etapa 2: Servir con http-server
FROM node:20-alpine

WORKDIR /app

# Instalar http-server globalmente
RUN npm install -g http-server

# Copiar los archivos compilados
COPY --from=builder /app/dist/walactvWeb/browser ./dist

EXPOSE 8080

CMD ["http-server", "./dist", "-p", "8080", "--proxy", "http://localhost:8080?"]
